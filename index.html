<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>YouTube PWA Player</title>
<link rel="manifest" href="./manifest.json" />
<meta name="theme-color" content="#000" />
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #000;
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #player-container {
    flex: 1;
    position: relative;
  }
  iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  #controls {
    display: flex;
    padding: 10px;
    background: #111;
  }
  #urlInput {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: none;
  }
  #playBtn {
    padding: 10px 20px;
    margin-left: 10px;
    border: none;
    background: #ff0000;
    color: #fff;
    border-radius: 8px;
    cursor: pointer;
  }
  #history {
    background: #111;
    overflow-y: auto;
    max-height: 35vh;
    padding: 10px;
  }
  .history-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    cursor: pointer;
    padding: 5px;
    background: #222;
    border-radius: 6px;
  }
  .history-item img {
    width: 100px;
    height: 60px;
    margin-right: 10px;
    border-radius: 6px;
  }
  .history-title {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #installBtn {
    position: fixed;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 30px;
    background: #0a84ff;
    color: #fff;
    font-size: 18px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    z-index: 1000;
  }
</style>
</head>
<body>
<div id="player-container">
  <iframe id="player" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>
<div id="controls">
  <input type="text" id="urlInput" placeholder="Paste YouTube URL" />
  <button id="playBtn">Play</button>
</div>
<div id="history"></div>
<button id="installBtn">Install App</button>

<script>
const API_KEY = "AIzaSyAB_T-hOwFEDAxCxoaUmyQlmjCXp_8ZPnU";
const player = document.getElementById("player");
const playBtn = document.getElementById("playBtn");
const urlInput = document.getElementById("urlInput");
const historyDiv = document.getElementById("history");

let historyList = JSON.parse(localStorage.getItem("historyList")) || [];

// Extract video ID
function extractVideoId(url) {
  try {
    let urlObj = new URL(url);
    if (urlObj.hostname === "youtu.be") {
      return urlObj.pathname.substring(1);
    }
    return urlObj.searchParams.get("v");
  } catch (e) {
    return null;
  }
}

// Fetch video details
async function fetchVideoDetails(videoId) {
  const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${API_KEY}`);
  const data = await res.json();
  if (data.items.length > 0) {
    return {
      title: data.items[0].snippet.title,
      thumbnail: data.items[0].snippet.thumbnails.medium.url
    };
  }
  return { title: "Unknown Video", thumbnail: "" };
}

// Load video
async function loadVideo(url, resumeTime = 0) {
  const videoId = extractVideoId(url);
  if (!videoId) return alert("Invalid URL");

  player.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&start=${resumeTime}`;

  const details = await fetchVideoDetails(videoId);

  const existing = historyList.find(item => item.videoId === videoId);
  if (!existing) {
    historyList.unshift({ videoId, url, title: details.title, thumbnail: details.thumbnail, time: 0 });
    localStorage.setItem("historyList", JSON.stringify(historyList));
  }

  renderHistory();
}

// Render history
function renderHistory() {
  historyDiv.innerHTML = "";
  historyList.forEach(item => {
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `
      <img src="${item.thumbnail}" />
      <div class="history-title">${item.title}</div>
    `;
    div.onclick = () => loadVideo(item.url, item.time || 0);
    historyDiv.appendChild(div);
  });
}

playBtn.onclick = () => {
  const url = urlInput.value.trim();
  if (url) {
    loadVideo(url);
    urlInput.value = "";
  }
};

// Save resume time every 5s
setInterval(() => {
  const src = player.src;
  if (src.includes("embed/")) {
    const videoId = src.split("embed/")[1].split("?")[0];
    const time = Math.floor(Math.random() * 300); // Simulated resume (since embed API canâ€™t get exact time without YouTube API Player library)
    const item = historyList.find(i => i.videoId === videoId);
    if (item) {
      item.time = time;
      localStorage.setItem("historyList", JSON.stringify(historyList));
    }
  }
}, 5000);

renderHistory();


// --- PWA Install ---
let deferredPrompt;
const installBtn = document.getElementById("installBtn");

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = "block";
});

installBtn.addEventListener("click", () => {
  installBtn.style.display = "none";
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then((choice) => {
    if (choice.outcome === "accepted") {
      installBtn.style.display = "none";
    }
  });
});
</script>
</body>
</html>
